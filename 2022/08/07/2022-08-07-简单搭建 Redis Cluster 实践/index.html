<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|JetBrains Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"xls56iii.github.io",root:"/",scheme:"Mist",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:"default"},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!0,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="Redis Cluster 是一种服务器 Sharding 技术，从 3.0 版本开始正式提供。Redis 的哨兵模式基本已经可以实现高可用，读写分离 ，但是在这种模式下每台 Redis 服务器都存储相同的数据，很浪费内存，所以在 Redis 3.0上加入了 Cluster 集群模式，实现了 Redis 的分布式存储，也就是说每台 Redis 节点上存储不同的内容。 本文主要介绍如何搭建简单的 R"><meta property="og:type" content="article"><meta property="og:title" content="简单搭建 Redis Cluster 集群实践"><meta property="og:url" content="https://xls56iii.github.io/2022/08/07/2022-08-07-%E7%AE%80%E5%8D%95%E6%90%AD%E5%BB%BA%20Redis%20Cluster%20%E5%AE%9E%E8%B7%B5/index.html"><meta property="og:site_name" content="Enjoy Coding"><meta property="og:description" content="Redis Cluster 是一种服务器 Sharding 技术，从 3.0 版本开始正式提供。Redis 的哨兵模式基本已经可以实现高可用，读写分离 ，但是在这种模式下每台 Redis 服务器都存储相同的数据，很浪费内存，所以在 Redis 3.0上加入了 Cluster 集群模式，实现了 Redis 的分布式存储，也就是说每台 Redis 节点上存储不同的内容。 本文主要介绍如何搭建简单的 R"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208131818025.png"><meta property="og:image" content="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208131818747.png"><meta property="og:image" content="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208131819615.png"><meta property="og:image" content="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208131819147.png"><meta property="og:image" content="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208131819563.png"><meta property="og:image" content="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208131819389.png"><meta property="og:image" content="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208131819980.png"><meta property="og:image" content="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208131819707.png"><meta property="og:image" content="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208131819375.png"><meta property="og:image" content="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208131819374.png"><meta property="og:image" content="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208131820925.png"><meta property="og:image" content="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208131820921.png"><meta property="og:image" content="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208131820249.png"><meta property="og:image" content="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208131820975.png"><meta property="og:image" content="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208160016068.png"><meta property="og:image" content="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208160025098.png"><meta property="og:image" content="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208160041087.png"><meta property="og:image" content="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208160049266.png"><meta property="og:image" content="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208160056278.png"><meta property="og:image" content="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208160117893.png"><meta property="og:image" content="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208160058176.png"><meta property="og:image" content="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208160131214.png"><meta property="og:image" content="https://raw.githubusercontent.com/xls56iii/blog-images/main/202210141423079.png"><meta property="og:image" content="https://raw.githubusercontent.com/xls56iii/blog-images/main/202210141424410.png"><meta property="og:image" content="https://raw.githubusercontent.com/xls56iii/blog-images/main/202210141425188.png"><meta property="og:image" content="https://raw.githubusercontent.com/xls56iii/blog-images/main/202209082315050.png"><meta property="article:published_time" content="2022-08-07T06:00:00.000Z"><meta property="article:modified_time" content="2025-02-25T15:24:08.000Z"><meta property="article:author" content="xls56i"><meta property="article:tag" content="K8S"><meta property="article:tag" content="Redis"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208131818025.png"><link rel="canonical" href="https://xls56iii.github.io/2022/08/07/2022-08-07-%E7%AE%80%E5%8D%95%E6%90%AD%E5%BB%BA%20Redis%20Cluster%20%E5%AE%9E%E8%B7%B5/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>简单搭建 Redis Cluster 集群实践 | Enjoy Coding</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">Enjoy Coding</h1><span class="logo-line-after"><i></i></span></a></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-life"><a href="/categories/Life" rel="section"><i class="fa fa-globe fa-fw"></i>生活</a></li><li class="menu-item menu-item-note"><a href="/categories/Note" rel="section"><i class="fa fa-book fa-fw"></i>笔记</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://xls56iii.github.io/2022/08/07/2022-08-07-%E7%AE%80%E5%8D%95%E6%90%AD%E5%BB%BA%20Redis%20Cluster%20%E5%AE%9E%E8%B7%B5/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="xls56i"><meta itemprop="description" content="Enjoy Coding & Enjoy Life"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Enjoy Coding"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">简单搭建 Redis Cluster 集群实践</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-08-07 14:00:00" itemprop="dateCreated datePublished" datetime="2022-08-07T14:00:00+08:00">2022-08-07</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2025-02-25 23:24:08" itemprop="dateModified" datetime="2025-02-25T23:24:08+08:00">2025-02-25</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><p><code>Redis Cluster</code> 是一种服务器 Sharding 技术，从 3.0 版本开始正式提供。Redis 的哨兵模式基本已经可以实现高可用，读写分离 ，但是在这种模式下每台 Redis 服务器都存储相同的数据，很浪费内存，所以在 Redis 3.0上加入了 Cluster 集群模式，实现了 Redis 的分布式存储，<strong>也就是说每台 Redis 节点上存储不同的内容</strong>。</p><p>本文主要介绍如何搭建简单的 Redis Cluster 集群，包括如何在本地环境、Docker 环境，以及在 K8S 环境下搭建。需要注意的是本文搭建的集群只是 3 个 master 组成的，并没有 slave，所以并不是高可用的，只是简单的用来演示。</p><span id="more"></span><h2 id="本地搭建三主-Redis-Cluster"><a href="#本地搭建三主-Redis-Cluster" class="headerlink" title="本地搭建三主 Redis Cluster"></a>本地搭建三主 Redis Cluster</h2><p>本地搭建三主 Redis Cluster 过程很简单，主要就是准备相应的配置文件，然后将 3 台 redis 实例启动后，在使用 <code>redis-cli</code> 命令初始化集群即可。</p><h3 id="1-下载-redis"><a href="#1-下载-redis" class="headerlink" title="1. 下载 redis"></a>1. 下载 redis</h3><p>MacOS 下载安装 redis 最简单的方法就是使用 <code>brew</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install redis</span><br></pre></td></tr></table></figure><p>使用 <code>brew</code> 安装好之后，相应的 <code>redis-server</code>和 <code>redis-cli</code> 命令都可以使用了。</p><p>如果想知道通过 <code>brew</code> 安装的 redis 在哪，可以使用命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew list redis</span><br></pre></td></tr></table></figure><h3 id="2-修改相应的配置文件，然后启动-3-台-redis-实例。"><a href="#2-修改相应的配置文件，然后启动-3-台-redis-实例。" class="headerlink" title="2. 修改相应的配置文件，然后启动 3 台 redis 实例。"></a>2. 修改相应的配置文件，然后启动 3 台 redis 实例。</h3><p>这里使用的 3 台 redis 实例端口号分别为 7001，7002 和 7003, 相应的配置文件只有 <code>port</code> 不同，相比较标准的 redis 配置文件 <code>redis.conf</code>，只需要修改下面的配置。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">port 7001</span><br><span class="line">bind 0.0.0.0</span><br><span class="line">appendonly yes</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file &quot;nodes.conf&quot;</span><br><span class="line">cluster-node-timeout 15000</span><br><span class="line">protected-mode no</span><br><span class="line">tcp-keepalive 300</span><br></pre></td></tr></table></figure><p>修改完后使用命令分别启动 3 台 redis 实例:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-server redis.conf</span><br></pre></td></tr></table></figure><h3 id="3-初始化集群"><a href="#3-初始化集群" class="headerlink" title="3. 初始化集群"></a>3. 初始化集群</h3><p>这里只是先启动了 3 台 redis， 还并没有组成集群。可以通过 <code>redis-cli</code> 命令登陆一台 redis 之后，查看相应的 <code>cluster info</code>， 发现并没有相应的集群信息</p><p><img src="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208131818025.png"></p><p>并且进行相应的 get 和 set 等操作也会出错。</p><p><img src="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208131818747.png"></p><p>之后通过 <code>redis-cli</code> 命令初始化集群，之前是需要使用 <code>redis-trib.rb</code> 脚本初始化集群，但是现在可以直接使用 <code>redis-cli</code>:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster create 127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003</span><br></pre></td></tr></table></figure><p>这里要注意，一开始我使用的命令是下面这条参考网上的，会有问题，因为网上基本都是搭建的三主三从的集群， <code>--cluster-replicas 1</code> 的意思是说一个 master 节点要对应一个 slave 节点，至少需要 6 台 redis， 我们这里没有 slave， 所以会出错。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster create --cluster-replicas 1 127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003</span><br></pre></td></tr></table></figure><p>命令执行的时候会先显示相应的集群信息，然后输入 yes 后即可建立集群。</p><p><img src="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208131819615.png"></p><h3 id="4-验证集群"><a href="#4-验证集群" class="headerlink" title="4. 验证集群"></a>4. 验证集群</h3><p>查看 <code>cluster info</code> 信息，发现已经有了相关的 slots, cluster_size 等信息</p><p><img src="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208131819147.png"></p><p>注意因为现在已经是集群模式，所以使用普通的独立实例模式登陆相应的 redis 进行操作会有问题</p><p><img src="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208131819563.png"></p><p>需要使用 <code>redis-cli</code>命令时加上 <code>-c</code> 参数</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -c -p 7001</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208131819389.png"></p><h2 id="Docker-搭建三主-Redis-Cluster"><a href="#Docker-搭建三主-Redis-Cluster" class="headerlink" title="Docker 搭建三主 Redis Cluster"></a>Docker 搭建三主 Redis Cluster</h2><p>使用 Docker 环境搭建 redis cluster。这里先写搭建步骤，最后再写搭建过程中遇到的坑！</p><h3 id="1-创建-3-个-redis-instances"><a href="#1-创建-3-个-redis-instances" class="headerlink" title="1. 创建 3 个 redis instances"></a>1. 创建 3 个 redis instances</h3><p>首先使用下面的 <code>docker-compose.yml</code> 文件，搭建出 3 个 redis instances，使用命令 <code>docker-compose up -d</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis1:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:7.0.4</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-node-1</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7001</span><span class="string">:7001</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">17001</span><span class="string">:17001</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-server</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--bind</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--port</span> <span class="number">7001</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--appendonly</span> <span class="literal">yes</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--cluster-enabled</span> <span class="literal">yes</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--cluster-config-file</span> <span class="string">&quot;nodes.conf&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--cluster-node-timeout</span> <span class="number">15000</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--protected-mode</span> <span class="literal">no</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--tcp-keepalive</span> <span class="number">300</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--cluster-announce-ip</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.100</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--cluster-announce-port</span> <span class="number">7001</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--cluster-announce-bus-port</span> <span class="number">17001</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis2:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:7.0.4</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-node-2</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7002</span><span class="string">:7002</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">17002</span><span class="string">:17002</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-server</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--bind</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--port</span> <span class="number">7002</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--appendonly</span> <span class="literal">yes</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--cluster-enabled</span> <span class="literal">yes</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--cluster-config-file</span> <span class="string">&quot;nodes.conf&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--cluster-node-timeout</span> <span class="number">15000</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--protected-mode</span> <span class="literal">no</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--tcp-keepalive</span> <span class="number">300</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--cluster-announce-ip</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.100</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--cluster-announce-port</span> <span class="number">7002</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--cluster-announce-bus-port</span> <span class="number">17002</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis3:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:7.0.4</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis-node-3</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7003</span><span class="string">:7003</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">17003</span><span class="string">:17003</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-server</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--bind</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--port</span> <span class="number">7003</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--appendonly</span> <span class="literal">yes</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--cluster-enabled</span> <span class="literal">yes</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--cluster-config-file</span> <span class="string">&quot;nodes.conf&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--cluster-node-timeout</span> <span class="number">15000</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--protected-mode</span> <span class="literal">no</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--tcp-keepalive</span> <span class="number">300</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--cluster-announce-ip</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.100</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--cluster-announce-port</span> <span class="number">7003</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--cluster-announce-bus-port</span> <span class="number">17003</span></span><br></pre></td></tr></table></figure><p>注意，在上面的 <code>docker-compose.yml</code> 文件中， <code>cluster-announce-ip</code> 为本机的 ip 地址，不能写 127.0.0.1、localhost 和 host.docker.internal 这些，原因后面会说。</p><h3 id="2-初始化集群"><a href="#2-初始化集群" class="headerlink" title="2. 初始化集群"></a>2. 初始化集群</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster create 192.168.0.100:7001 192.168.0.100:7002 192.168.0.100:7003</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208131819980.png"></p><h3 id="3-验证集群"><a href="#3-验证集群" class="headerlink" title="3. 验证集群"></a>3. 验证集群</h3><p>和前面的方法一样，简单验证一下 get 等方法。</p><p><img src="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208131819707.png"></p><h3 id="4-TroubleShooting"><a href="#4-TroubleShooting" class="headerlink" title="4. TroubleShooting"></a>4. TroubleShooting</h3><ul><li><p>ERR Invalid node address specified</p><p>这个错误的原因是 <code>redis-cli</code> 命令初始化集群时，是不允许使用域名的，只能用 ip，<code>redis-cli --cluster create</code> 命令和登陆一个 redis 实例，然后使用 <code>cluster meet ip</code> 是等价的， 都是不允许使用域名的，这也就解释了 <code>cluster-announce-ip</code> 不能使用 host.docker.internal，至于为什么不能使用 127.0.0.1 和 localhost， 因为 redis 是在一个容器中的，docker 会为每个容器分配自己的 network namespace，所以这里的 127.0.0.1 指的是容器自己本身，而不是宿主机本身。</p></li><li><p><code>--net host</code> 或者 <code>network_mode: host</code></p><p>使用 <code>host</code> 的网络模式，这样的话容器是共享的宿主机的 network，也就是说容器没有自己分配的 ip，和宿主机的网络是相同的，这样的话也不用指定端口映射关系了，而且这样我认为 redis 之间通信是可以使用 127.0.0.1 的。<a target="_blank" rel="noopener" href="https://docs.docker.com/network/host/">但是遗憾的是 MacOS 和 Windows 不支持这种模式，只有 Linux 可以</a>，当时因为这个试了半天一直没想明白原因，然后才知道是不支持。</p></li><li><p>一定要配置 <code>cluster-announce-ip</code></p><p>有了上面的两点背景，导致我们在 Mac 上就一定要指定本机的 ip 才行，那么为什么要配置 <code>cluster-announce-ip</code> 这个呢？当时也踩了坑！因为 Mac 不支持 host 模式，所以我们创建出的容器，都会分配一个容器自己的 ip，这个 ip 是在容器自己的 networking namespace 下的。我们看一下不指定这个配置的现象。</p><p>下面是创建好的 3 个 redis 容器:</p><p><img src="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208131819375.png"></p><p>以 redis-node-3 为例, 使用 <code>docker inspect $&#123;CONTAINER ID&#125;</code> 查看相关信息，可以发现这个容器有自己的 IPAddress</p><p><img src="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208131819374.png"></p><p>然后在我们初始化集群的时候，虽然命令使用的 ip 是 <code>192.168.0.100</code>，但是实际 redis 之间进行通信时，使用的却是 <code>172.23.0.3</code></p><p><img src="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208131820925.png"></p><p>虽然这里最后显示的是 ERROR，但是实际上集群已经初始化好了，可以进入任意一个 redis 容器内查看:</p><p><img src="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208131820921.png"></p><p>虽然我们在容器内部的各种操作是没有什么问题的，但是我们在本地测试时，如果使用宿主机 ip，就会有问题，</p><p><img src="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208131820249.png"></p><p>宿主机显然是无法连接到容器自己的 networking namespace 下 ip 的，根据上面的现象可以发现，如果不置指定 <code>cluster-announce-ip</code> 的话，实际上初始化集群时使用的是容器自己的 ip。</p></li><li><p>Waiting for the cluster to join</p><p>还有一个问题就是在初始化集群时一直显示<em>Waiting for the cluster to join</em>，<a target="_blank" rel="noopener" href="https://redis.io/docs/manual/scaling/#redis-cluster-tcp-ports">这个的原因是因为除了需要开放 redis 连接需要的端口外(e.g., 6379)，redis 之间通信还需要开放一个额外的端口，这个端口是在前面的端口号上加上 10000 (e.g., 16379)</a></p></li><li><p>一开始还遇到了一个很坑的问题，就是即使上面的问题都解决了，但是在本地无法通过宿主机 ip 登陆 redis <code>redis-cli -h 192.168.0.100 -p 7001</code>， ping 这个 ip 或者 127.0.0.1 也是不通，后来发现是因为我一开始用的是公司的电脑，公司电脑的防火墙选项中，<code>隐身模式</code> 是勾选上的，而且不能关掉，所以会有上面的问题，后来就在自己的电脑上做实验了。</p><p><img src="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208131820975.png"></p></li><li><p>container_name not work</p><p>这个问题倒是不影响，只是当时挺奇怪的，因为我的 <code>docker-compose.yml</code> 文件放在了 <code>redis-cluster</code> 文件夹下面，然后 <code>container_name</code> 取得是 <code>redis-cluster-1, redis-cluster-2, redis-cluster-3</code>，然后创建好容器后发现 docker 上显示的 <code>container_name</code> 分别是 <code>1, 2, 3</code>，一开始还以为是配置有问题，然后把 <code>container_name</code> 改成了 <code>redis-node-1, redis-node-2, redis-node-3</code> 之后就显示正常了，这才注意到是因为文件夹的名字的原因。</p></li></ul><h2 id="K8S-搭建三主-Redis-Cluster"><a href="#K8S-搭建三主-Redis-Cluster" class="headerlink" title="K8S 搭建三主 Redis Cluster"></a>K8S 搭建三主 Redis Cluster</h2><h3 id="1-声明"><a href="#1-声明" class="headerlink" title="1. 声明"></a>1. 声明</h3><p>使用 K8S 搭建 Redis Cluster 集群， 需要创建有状态的 <code>StatefulSet</code> 类型，Redis 中存储的数据倒是次要原因，主要原因还是 Redis 中存储了和集群相关的信息，比如下面的配置文件中，集群信息会存储在 <code>cluster-config-file /data/nodes.conf</code>，如果是 Deployment 类型的，当 Pod 挂掉删除重启后，相应的数据也会消失，这样 Redis Cluster 就不能自行通过通信恢复，而是需要人为重新初始化，这里为了简单，也是为了了解两种方式之间的差别，先创建 Deployment 类型的 Redis Cluster 集群。</p><h3 id="2-创建集群"><a href="#2-创建集群" class="headerlink" title="2. 创建集群"></a>2. 创建集群</h3><p>使用下面的 <code>yml</code> 文件，在 K8S 中创建相应的资源，命令为 <code>kubectl apply -f xxx.yml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis-cluster</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">client</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">16379</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">16379</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gossip</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">redis-cluster</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis-cluster</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">update-node.sh:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    #!/bin/sh</span></span><br><span class="line"><span class="string">    REDIS_NODES=&quot;/data/nodes.conf&quot;</span></span><br><span class="line"><span class="string">    sed -i -e &quot;/myself/ s/[0-9]\&#123;1,3\&#125;\.[0-9]\&#123;1,3\&#125;\.[0-9]\&#123;1,3\&#125;\.[0-9]\&#123;1,3\&#125;/$&#123;POD_IP&#125;/&quot; $&#123;REDIS_NODES&#125;</span></span><br><span class="line"><span class="string">    exec &quot;$@&quot;</span></span><br><span class="line"><span class="string"></span>  <span class="attr">redis.conf:</span> <span class="string">|+</span></span><br><span class="line"><span class="string">    cluster-enabled yes</span></span><br><span class="line"><span class="string">    cluster-require-full-coverage no</span></span><br><span class="line"><span class="string">    cluster-node-timeout 15000</span></span><br><span class="line"><span class="string">    cluster-config-file /data/nodes.conf</span></span><br><span class="line"><span class="string">    protected-mode no</span></span><br><span class="line"><span class="string">    save &quot;&quot;</span></span><br><span class="line"><span class="string"></span><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis-cluster</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">redis-cluster</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">redis-cluster</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">redis:latest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">6379</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">client</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">16379</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">gossip</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;/conf/update-node.sh&quot;</span>, <span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/conf/redis.conf&quot;</span>]</span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_IP</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">status.podIP</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">conf</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/conf</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">conf</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">redis-cluster</span></span><br><span class="line">          <span class="attr">defaultMode:</span> <span class="number">0755</span></span><br></pre></td></tr></table></figure><p>这样相应的 Redis Cluster 集群的资源就已经创建好了</p><p><img src="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208160016068.png"></p><h3 id="3-初始化集群-1"><a href="#3-初始化集群-1" class="headerlink" title="3. 初始化集群"></a>3. 初始化集群</h3><p>当 K8S 的相关资源初始化之后，下一步就是初始化 Redis Cluster 集群，这一步即使是使用 <code>StatefulSet</code> 类型的，也是必不可少的，因为第一次初始化集群是都是要手动操作，只不过 <code>StatefulSet</code> 类型的之后就不再需要手动操作，而是会自身通过 Gossip 通信完成。</p><p>首先查看 3 个 Pod 的 IP 地址，因为我们创建了相应的 Service，所以可以直接通过查看 Service 的 Endpoints 来查看 3 个 Pod 的相应 IP</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe svc redis-cluster</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208160025098.png"></p><p>之后随便进入一个 Pod 中初始化集群即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it redis-cluster-b589bd6fb-47jk8 sh</span><br><span class="line">redis-cli --cluster create 172.17.0.11:6379 172.17.0.7:6379 172.17.0.8:6379</span><br></pre></td></tr></table></figure><h3 id="4-验证集群-1"><a href="#4-验证集群-1" class="headerlink" title="4. 验证集群"></a>4. 验证集群</h3><p>普通的验证 get 和 set 等方法和之前介绍的一样，这里验证一下当一个 Pod 重启后，是否可以恢复该集群，在重启 Pod 之前，我们先看一下 Pod 中的 <code>nodes.conf</code> 里记录的是什么:</p><p><img src="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208160041087.png"></p><p>分别是 Redis Cluster 中的 node 的 ID，这个是初始化集群时赋予的，不会被改变，后面跟着的是 node 的 IP:PORT，当我们删除掉 <code>redis-cluster-b589bd6fb-msbfp</code> 这个 Pod 后，K8S 会自动再创建一个</p><p><img src="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208160049266.png"></p><p>这是进去查看 <code>nodes.conf</code> 文件，发现只有自己 node 本身的信息，因为 Deployment 是无状态的，上一个 Pod 删除之后相应的数据也都删除了，而且 Redis Cluster 集群也没有自动恢复。</p><p><img src="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208160056278.png"></p><p>进入没有重启的 node 节点查看相应的集群信息，会发现挂掉的 Pod 的 IP 信息，也变成了 <code>0@0</code> ，并不会保留之前的 IP 信息。(下面这张图是另一次实验的截图，所以 ID, IP 这些和其他的不对应)</p><p><img src="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208160117893.png"></p><p>这时只能通过 <code>cluster meet IP PORT</code> 命令主动通信，恢复集群</p><p><img src="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208160058176.png"></p><div class="note danger"><p>这里其实也是会有问题的，因为新生成的 Pod 对应的 node ID 也会产生变化，但是 node 之间通信如果节点的 ID 变化了，也不会通信成功。就像下面图中的一样，虽然在新的 Pod 节点上 meet 成功，但是发现他的节点 ID 发生了变化，之前是 d8e03*** 现在变成了 b4a61***， 所以虽然主动 meet 的 172.17.0.11 成功了， 但是随后自动通信的 172.17.0.7 是无法连接的， 而且还注意到重启的 Pod 如果节点 ID 发生了变化，也是没有 Slot 分配信息的，这种情况下就只能进行重建集群了。这也是为什么在 K8S 环境中搭建 Redis Cluster 集群需要使用 StatefulSet 的最主要原因。</p></div><p><img src="https://raw.githubusercontent.com/xls56iii/blog-images/main/202208160131214.png"></p><h3 id="5-update-node-sh"><a href="#5-update-node-sh" class="headerlink" title="5. update-node.sh"></a>5. update-node.sh</h3><p>注意到上面的 yml 文件中有一段 <code>update-node.sh</code> 脚本，其实这段脚本是用在 <code>StatefulSet</code> 类型中用于自动恢复集群的，在 Deployment 类型中可以不用这段脚本，集群的自动恢复，主要就是通过 <code>nodes.conf</code> 里记录的各个 node 的 IP 信息来恢复的，但是当 Pod 重启之后，Pod 对应的 IP 可能会发生改变，所以即使使用 <code>StatefulSet</code> 类型，等 Pod 恢复后，原来的 <code>nodes.conf</code> 文件还在，但是如果 Pod 的 IP 发生了改变，也无法恢复集群。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">REDIS_NODES=&quot;/data/nodes.conf&quot;</span><br><span class="line">sed -i -e &quot;/myself/ s/[0-9]\&#123;1,3\&#125;\.[0-9]\&#123;1,3\&#125;\.[0-9]\&#123;1,3\&#125;\.[0-9]\&#123;1,3\&#125;/$&#123;POD_IP&#125;/&quot; $&#123;REDIS_NODES&#125;</span><br><span class="line">exec &quot;$@&quot;</span><br></pre></td></tr></table></figure><p>这段脚本的作用就是，在 Pod 恢复之后，把 <code>nodes.conf</code> 中的 <code>myself</code> 的 IP 信息， 更改为当前 Pod 的 POD_IP，这个 POD_IP 是通过环境变量 <code>status.podIP</code> 获取到的，这样集群就可以自动恢复。</p><div class="note danger"><p>后来经过试验发现，<code>update-node.sh</code> 这段代码可能并不是必须的，redis 集群在通信时会自动更新自己节点的新 IP，实验步骤如下：</p><ul><li><p>本地启动 3 个 redis，并组成集群，redis 地址分别为: 127.0.0.1:7001, 127.0.0.1:7002, 127.0.0.1:7003</p><p><img src="https://raw.githubusercontent.com/xls56iii/blog-images/main/202210141423079.png"></p></li><li><p>关闭 127.0.0.1:7003 这台 redis</p><p><img src="https://raw.githubusercontent.com/xls56iii/blog-images/main/202210141424410.png"></p></li><li><p>更改 127.0.0.1:7003 这台 redis 的配置，将其端口号改为 7004，来模拟 IP 发生变动，启动该 redis。</p><p><img src="https://raw.githubusercontent.com/xls56iii/blog-images/main/202210141425188.png"></p></li></ul><p>可以发现 <code>nodes.conf</code> 中的 IP 地址是会自动更新的，有可能是因为 7001 和 7002 这两个 redis 是好的，7004 根据 <code>nodes.conf</code> 中的记录，可以正确的与 7001、7002 通信，通信成功之后，7001 和 7002 会发现第 3 台 redis 的地址已经变成了 127.0.0.1:7004，然后会将该信息在集群中进行传播，自动更新 <code>nodes.conf</code> 中的内容，所以 <code>update-node.sh</code> 脚本不是必要的。</p><p>另外一点: 如果当所有的 redis 节点的 IP 都改变了，这时应该集群是不能自动恢复正常的。</p></div><h3 id="6-StatefulSet"><a href="#6-StatefulSet" class="headerlink" title="6. StatefulSet"></a>6. StatefulSet</h3><p>下面提供了可用的 StatefulSet 类型的 YAML 文件，具体搭建集群步骤和上面的 Deployment 一样，先创建好资源，然后初始化集群即可，这里不再赘述。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis-cluster</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">update-node.sh:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    #!/bin/sh</span></span><br><span class="line"><span class="string">    REDIS_NODES=&quot;/data/nodes.conf&quot;</span></span><br><span class="line"><span class="string">    sed -i -e &quot;/myself/ s/[0-9]\&#123;1,3\&#125;\.[0-9]\&#123;1,3\&#125;\.[0-9]\&#123;1,3\&#125;\.[0-9]\&#123;1,3\&#125;/$&#123;POD_IP&#125;/&quot; $&#123;REDIS_NODES&#125;</span></span><br><span class="line"><span class="string">    exec &quot;$@&quot;</span></span><br><span class="line"><span class="string"></span>  <span class="attr">redis.conf:</span> <span class="string">|+</span></span><br><span class="line"><span class="string">    cluster-enabled yes</span></span><br><span class="line"><span class="string">    cluster-require-full-coverage no</span></span><br><span class="line"><span class="string">    cluster-node-timeout 15000</span></span><br><span class="line"><span class="string">    cluster-config-file /data/nodes.conf</span></span><br><span class="line"><span class="string">    cluster-migration-barrier 1</span></span><br><span class="line"><span class="string">    protected-mode no</span></span><br><span class="line"><span class="string">    maxmemory 2000000000</span></span><br><span class="line"><span class="string">    save &quot;&quot;</span></span><br><span class="line"><span class="string"></span><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis-cluster</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">redis-cluster</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">redis-cluster</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">redis-cluster</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">redis:latest</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">6379</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">client</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">16379</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">gossip</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;/conf/update-node.sh&quot;</span>, <span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/conf/redis.conf&quot;</span>]</span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_IP</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">fieldRef:</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">status.podIP</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">conf</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/conf</span></span><br><span class="line">              <span class="attr">readOnly:</span> <span class="literal">false</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/data</span></span><br><span class="line">              <span class="attr">readOnly:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">conf</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">redis-cluster</span></span><br><span class="line">            <span class="attr">defaultMode:</span> <span class="number">0755</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">      <span class="attr">spec:</span></span><br><span class="line">        <span class="attr">accessModes:</span> [ <span class="string">&quot;ReadWriteOnce&quot;</span> ]</span><br><span class="line">        <span class="attr">storageClassName:</span> <span class="string">standard</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis-cluster</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">6379</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">client</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">16379</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">16379</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">gossip</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">redis-cluster</span></span><br></pre></td></tr></table></figure><div class="note info"><h4 id="几个参数介绍"><a href="#几个参数介绍" class="headerlink" title="几个参数介绍"></a>几个参数介绍</h4><ul><li><p>cluster-require-full-coverage 为 no 时，表示当一个 master 节点 down 掉之后并且没有 slave 节点进行故障恢复时，集群仍然可用。</p></li><li><p>cluster-migration-barrier &lt;num&gt; 用来决定 slave 数量达到多少个才会把冗余 slave 漂移出去。</p></li></ul></div><h2 id="create-cluster-快速搭建三主三从集群"><a href="#create-cluster-快速搭建三主三从集群" class="headerlink" title="create-cluster 快速搭建三主三从集群"></a>create-cluster 快速搭建三主三从集群</h2><h3 id="1-从官网下载-Redis-源码"><a href="#1-从官网下载-Redis-源码" class="headerlink" title="1. 从官网下载 Redis 源码"></a>1. 从<a target="_blank" rel="noopener" href="https://redis.io/download/">官网</a>下载 Redis 源码</h3><p><img src="https://raw.githubusercontent.com/xls56iii/blog-images/main/202209082315050.png"></p><h3 id="2-官方提供了-create-cluster-工具快速搭建集群"><a href="#2-官方提供了-create-cluster-工具快速搭建集群" class="headerlink" title="2. 官方提供了 create-cluster 工具快速搭建集群"></a>2. 官方提供了 <code>create-cluster</code> 工具快速搭建集群</h3><p>脚本路径为: <code>redis-7.0.4/utils/create-cluster</code>， 使用下面几个命令进行操作</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./create-cluster start  # 启动 6 台 redis</span><br><span class="line">./create-cluster create  # cluster 集群初始化</span><br><span class="line">./create-cluster stop  # 关闭集群</span><br><span class="line">./create-cluster clean  # 清理集群</span><br></pre></td></tr></table></figure></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者： </strong>xls56i</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://xls56iii.github.io/2022/08/07/2022-08-07-%E7%AE%80%E5%8D%95%E6%90%AD%E5%BB%BA%20Redis%20Cluster%20%E5%AE%9E%E8%B7%B5/" title="简单搭建 Redis Cluster 集群实践">https://xls56iii.github.io/2022/08/07/2022-08-07-简单搭建 Redis Cluster 实践/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/K8S/" rel="tag"><i class="fa fa-tag"></i> K8S</a> <a href="/tags/Redis/" rel="tag"><i class="fa fa-tag"></i> Redis</a></div><div class="post-nav"><div class="post-nav-item"><a href="/2022/08/07/2022-08-13-leetcode/" rel="prev" title="Two Sum"><i class="fa fa-chevron-left"></i> Two Sum</a></div><div class="post-nav-item"><a href="/2022/08/21/2022-08-21-Git/" rel="next" title="Git">Git <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%AC%E5%9C%B0%E6%90%AD%E5%BB%BA%E4%B8%89%E4%B8%BB-Redis-Cluster"><span class="nav-number">1.</span> <span class="nav-text">本地搭建三主 Redis Cluster</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E4%B8%8B%E8%BD%BD-redis"><span class="nav-number">1.1.</span> <span class="nav-text">1. 下载 redis</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E4%BF%AE%E6%94%B9%E7%9B%B8%E5%BA%94%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%EF%BC%8C%E7%84%B6%E5%90%8E%E5%90%AF%E5%8A%A8-3-%E5%8F%B0-redis-%E5%AE%9E%E4%BE%8B%E3%80%82"><span class="nav-number">1.2.</span> <span class="nav-text">2. 修改相应的配置文件，然后启动 3 台 redis 实例。</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%88%9D%E5%A7%8B%E5%8C%96%E9%9B%86%E7%BE%A4"><span class="nav-number">1.3.</span> <span class="nav-text">3. 初始化集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E9%AA%8C%E8%AF%81%E9%9B%86%E7%BE%A4"><span class="nav-number">1.4.</span> <span class="nav-text">4. 验证集群</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Docker-%E6%90%AD%E5%BB%BA%E4%B8%89%E4%B8%BB-Redis-Cluster"><span class="nav-number">2.</span> <span class="nav-text">Docker 搭建三主 Redis Cluster</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%88%9B%E5%BB%BA-3-%E4%B8%AA-redis-instances"><span class="nav-number">2.1.</span> <span class="nav-text">1. 创建 3 个 redis instances</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%88%9D%E5%A7%8B%E5%8C%96%E9%9B%86%E7%BE%A4"><span class="nav-number">2.2.</span> <span class="nav-text">2. 初始化集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E9%AA%8C%E8%AF%81%E9%9B%86%E7%BE%A4"><span class="nav-number">2.3.</span> <span class="nav-text">3. 验证集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-TroubleShooting"><span class="nav-number">2.4.</span> <span class="nav-text">4. TroubleShooting</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#K8S-%E6%90%AD%E5%BB%BA%E4%B8%89%E4%B8%BB-Redis-Cluster"><span class="nav-number">3.</span> <span class="nav-text">K8S 搭建三主 Redis Cluster</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%A3%B0%E6%98%8E"><span class="nav-number">3.1.</span> <span class="nav-text">1. 声明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4"><span class="nav-number">3.2.</span> <span class="nav-text">2. 创建集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%88%9D%E5%A7%8B%E5%8C%96%E9%9B%86%E7%BE%A4-1"><span class="nav-number">3.3.</span> <span class="nav-text">3. 初始化集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E9%AA%8C%E8%AF%81%E9%9B%86%E7%BE%A4-1"><span class="nav-number">3.4.</span> <span class="nav-text">4. 验证集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-update-node-sh"><span class="nav-number">3.5.</span> <span class="nav-text">5. update-node.sh</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-StatefulSet"><span class="nav-number">3.6.</span> <span class="nav-text">6. StatefulSet</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%87%A0%E4%B8%AA%E5%8F%82%E6%95%B0%E4%BB%8B%E7%BB%8D"><span class="nav-number">3.6.1.</span> <span class="nav-text">几个参数介绍</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#create-cluster-%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA%E4%B8%89%E4%B8%BB%E4%B8%89%E4%BB%8E%E9%9B%86%E7%BE%A4"><span class="nav-number">4.</span> <span class="nav-text">create-cluster 快速搭建三主三从集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E4%BB%8E%E5%AE%98%E7%BD%91%E4%B8%8B%E8%BD%BD-Redis-%E6%BA%90%E7%A0%81"><span class="nav-number">4.1.</span> <span class="nav-text">1. 从官网下载 Redis 源码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%AE%98%E6%96%B9%E6%8F%90%E4%BE%9B%E4%BA%86-create-cluster-%E5%B7%A5%E5%85%B7%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA%E9%9B%86%E7%BE%A4"><span class="nav-number">4.2.</span> <span class="nav-text">2. 官方提供了 create-cluster 工具快速搭建集群</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="xls56i" src="/images/avatar.png"><p class="site-author-name" itemprop="name">xls56i</p><div class="site-description" itemprop="description">Enjoy Coding & Enjoy Life</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives"><span class="site-state-item-count">30</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">4</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">30</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="mailto:947252044@qq.com" title="E-Mail → mailto:947252044@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a> </span><span class="links-of-author-item"><a href="https://github.com/xls56iii" title="Github → https:&#x2F;&#x2F;github.com&#x2F;xls56iii" rel="noopener" target="_blank"><i class="iconfont icongithub fa-fw"></i>Github</a></span></div><div class="cc-license motion-element" itemprop="license"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2025</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">xls56i</span></div><div><span id="busuanzi_container_site_pv">本站总访问量 <span id="busuanzi_value_site_pv"></span> 次 </span>｜ <span id="busuanzi_container_site_uv">本站总访客数 <span id="busuanzi_value_site_uv"></span> 人</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></footer></div><script src="/lib/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/code-unfold.js"></script><script src="/js/local-search.js"></script><script>function loadCount(){var d=document,t=d.createElement("script");t.src="https://xls56i.disqus.com/count.js",t.id="dsq-count-scr",(d.head||d.body).appendChild(t)}window.addEventListener("load",loadCount,!1)</script></body></html>